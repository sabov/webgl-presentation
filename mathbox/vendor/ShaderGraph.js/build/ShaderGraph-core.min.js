(function(c){for(var a in c)if(!window[a])throw"Error: ShaderGraph requires "+c[a];})({THREE:"Three.js"});window.ShaderGraph={};ShaderGraph.getShader=function(c){var a=document.getElementById(c);return a&&(a.innerText||a.textContent)||c};
(function(c){c.Block=function(a){a=a||new c.Node;this.node(a);this.children=[];this.parent=null;this.properties={};this.index=++c.Block.index;this.refresh()};c.Block.index=0;c.Block.prototype={node:function(a){return void 0!==a?(this._node=a,this):this._node},refresh:function(){this._node.owner(this);this._node.outlets(this.outlets())},fetch:function(a,b,e,c){},id:function(a,b,e,d){if(e.meta.inout){var g=e.node.get(e.name,c.IN).input;if(g)return g.node.owner().fetch(a,b,g,d+1)}return e.id()}};c.Block.Snippet=
function(a){this.snippet=new c.Snippet(a);c.Block.call(this)};c.Block.Snippet.prototype=_.extend({},c.Block.prototype,{insert:function(a,b,e){c.Block.Snippet.compileCall(a,b,this.node(),this.snippet,e)},fetch:function(a,b,e,c){a.include(this,b)||this.insert(a,b,c);return this.id(a,b,e,c)},outlets:function(){return c.Block.Snippet.makeOutlets(this.snippet)}});c.Block.Material=function(a,b){this.vertex=new c.Snippet(a);this.fragment=new c.Snippet(b);c.Block.call(this)};c.Block.Material.prototype=_.extend({},
c.Block.prototype,{compile:function(){if(0<this.node().outputs.length)throw"Can't compile material with outputs";this.node();var a=new c.Program;this.insert(a,"vertex",0);this.insert(a,"fragment",0);a.compile();return a},insert:function(a,b,e){c.Block.Snippet.compileCall(a,b,this.node(),this[b],e)},fetch:function(a,b,c,d){a.include(this,b)||this.insert(a,b,d);"fragment"==b&&(a.include(this,"vertex")||this.insert(a,"vertex",0));return this.id(a,b,c,d)},outlets:function(){var a=c.Block.Snippet.makeOutlets(this.vertex),
b=c.Block.Snippet.makeOutlets(this.fragment);return _.union(a,b)}});c.Block.Snippet.makeOutlets=function(a){var b=[];if(a.outlets)return a.outlets;var e=a.arguments();_.each(e.parameters,function(a){a=_.extend({},a);a.meta={required:!0};a.hint=a.name.replace(/(In|Out)$/,"");a.category="parameter";if(a.inout==c.INOUT){a.meta.inout=!0;var e=_.extend({},a);e.inout=c.IN;b.push(e);a.inout=c.OUT}b.push(a)});_.each(e.uniforms,function(a){a.meta={};a.hint=a.name.replace(/(In|Out)$/,"");a.category="uniform";
a.inout=c.IN;b.push(a)});return a.outlets=b};c.Block.Snippet.compileCall=function(a,b,e,d,g){var f=d.arguments(),h=[];_.each(f.parameters,function(f){var d=e.get(f.name,f.inout==c.INOUT?c.IN:f.inout);if(f.inout==c.IN||f.inout==c.INOUT)if(d.input)d=d.input.node.owner().fetch(a,b,d.input,g+1),a.variable(b,d,f),h.push(d);else throw console.log("Outlet",f,input),["Missing connection on outlet for "+f.name];else f.inout==c.OUT&&(d=d.id(),a.variable(b,d,f),h.push(d))});var k=[];_.each(f.uniforms,function(c){var f=
e.get(c.name);f.input?(f=f.input.node.owner().fetch(a,b,f.input,g+1),a.variable(b,f,c),h.push(f),k.push(c.name)):a.external("uniform",c)});_.each(f.attributes,function(b){a.external("attribute",b)});_.each(f.varyings,function(b){a.external("varying",b)});f=["_sg",b,d.name,e.owner().index].join("_");d=d.compile(f,k,!0);a.add(b,f,h,d,g)}})(ShaderGraph);
(function(c){c.Factory=function(){this.end()};c.Factory.prototype={snippet:function(a,b){b=b||"append";var e=new c.Block.Snippet(ShaderGraph.getShader(a));this[b](e.node());return this},material:function(a,b,e){e=e||"append";a=new c.Block.Material(ShaderGraph.getShader(a),ShaderGraph.getShader(b));this[e](a.node());return this},snippetBefore:function(a){this.snippet(a,"prepend");return this},materialBefore:function(a,b){this.material(code,"prepend");return this},append:function(a){a.graph||this.graph.add(a);
var b=this.stack[0];_.each(b.end,function(b){b.connect(a)});b.start.length||(b.start=[a]);b.end=[a];return this},prepend:function(a){a.graph||this.graph.add(a);var b=this.stack[0];_.each(b.start,function(b){a.connect(b)});b.end.length||(b.end=[a]);b.start=[a];return this},group:function(){this.stack.unshift({start:[],end:[]});this.stack.unshift({start:[],end:[]});return this},pass:function(){this.next();this.stack[0].start.push(null);return this.combine()},next:function(){var a=this.stack.shift(),
b=this.stack[0];b.start=b.start.concat(a.start);b.end=b.end.concat(a.end);this.stack.unshift({start:[],end:[]});return this},combine:function(){if(2>=this.stack.length)throw"Popping factory stack too far.";this.next();this.stack.shift();var a=this.stack.shift(),b=this.stack[0];a.start.length&&(_.each(a.start,function(c){c?_.each(b.end,function(a){a.connect(c,!0)}):a.end=a.end.concat(b.end)}),b.end=a.end);return this},end:function(){var a=this.graph;this.graph=new c.Graph;this.stack=[];this.group();
a&&(a.compile=function(){return a.tail().owner().compile()});return a}}})(ShaderGraph);
(function(c){c.Program=function(){this.calls={vertex:{},fragment:{}};this.variables={vertex:{},fragment:{}};this.externals={};this.compiled=!1;this.attributes={};this.uniforms={};this.fragmentShader=this.vertexShader="";this.includes={vertex:[],fragment:[]}};c.Program.types={f:"float",v2:"vec2",v3:"vec3",v4:"vec4",m3:"mat3",m4:"mat4",t:"sampler2D"};c.Program.prototype={include:function(a,b){if(0<=this.includes[b].indexOf(a))return!0;this.includes[b].push(a);return!1},external:function(a,b){b=_.extend({category:a},
b);this.externals[b.name]=b},variable:function(a,b,c){c=_.extend({},c,{name:b});this.variables[a][b]=c},add:function(a,b,c,d,g){var f=this.calls[a][b];f?f.priority=Math.min(f.priority,g):this.calls[a][b]={name:b,args:c,code:d,priority:g}},compile:function(){_.each(this.externals,function(a){"uniform"==a.category&&(this.uniforms[a.name]={type:a.type,value:a.value});"attribute"==a.category&&(this.attributes[a.name]={type:a.type,value:[]})}.bind(this));_.each(["vertex","fragment"],function(a){var b=
[];_.each(this.externals,function(c){"attribute"==c.category&&"fragment"==a||b.push([c.category,c.signature,";"].join(" "))}.bind(this));var b=b.join("\n"),e=_.toArray(this.calls[a]),d=[b],g=["void main() {"];_.each(this.variables[a],function(a){g.push([c.Program.types[a.type],a.name,";"].join(" "))});e.sort(function(a,b){return b.priority-a.priority});_.each(e,function(a){d.push(a.code);g.push([a.name,"(",a.args.join(","),");"].join(""))});g.push("}");this[a+"Shader"]=[d.join("\n"),g.join("\n")].join("\n")}.bind(this));
this.compiled=!0},material:function(){if(!this.compiled)throw"Fetching material from uncompiled program.";return new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:this.vertex,fragmentShader:this.fragment})}}})(ShaderGraph);
(function(c){c.Snippet=function(a){if(c.Snippet.cache[a])return c.Snippet.cache[a];c.Snippet.cache[a]=this;this.code=a;this.attributes=[];this.uniforms=[];this.varyings=[];this.parameters=[];this.body=this.signature="";this.parseCode(a)};c.Snippet.cache={};c.Snippet.types={"float":"f",vec2:"v2",vec3:"v3",vec4:"v4",mat3:"m3",mat4:"m4",sampler2D:"t",samplerCube:"t"};c.Snippet.defaults={"float":0,vec2:new THREE.Vector3,vec3:new THREE.Vector3,vec4:new THREE.Vector4,mat4:new THREE.Matrix4,sampler2D:0,
samplerCube:0};c.Snippet.prototype={compile:function(a,b,c){var d=this.signature.slice(),g=[];b=b||[];_.each(this.uniforms,function(a){0<=b.indexOf(a.name)?d.push(a.signature):c||g.push(["uniform",a.signature].join(" "))});!c&&_.each(this.attributes,function(a){g.push(["attribute",a.signature].join(" "))});!c&&_.each(this.varyings,function(a){g.push(["varying",a.signature].join(" "))});a=this.body.replace(/\s*void\s+([A-Za-z0-9]+)\s*\([^\)]*\)/g,["void",a+"(",d.join(", "),")"].join(" "));g.push(a);
return g.join(";\n")},arguments:function(){return{uniforms:this.uniforms,varyings:this.varyings,attributes:this.attributes,parameters:this.parameters}},type:function(a,b){a=(c.Snippet.types[a]||"f")+(b?"v":"");return"fv"==a?"fv1":a},parseAttribute:function(a){var b=a[1];this.attributes.push({name:a[3],type:this.type(a[2],a[4]),signature:b})},parseUniform:function(a){var b=a[1],e=a[2];this.uniforms.push({name:a[3],type:this.type(e,a[4]),value:c.Snippet.defaults[e]||0,signature:b})},parseVarying:function(a){var b=
a[1];this.varyings.push({name:a[3],type:this.type(a[2],a[4]),signature:b})},parseSignature:function(a){this.name=a[1];var b=a[2].replace(/^\s*$/g,"");0==b.length?this.signature=[]:(arguments=this.signature=b.split(","),_.each(arguments,function(a){a=/((?:(in|out|inout)\s+)?([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/.exec(a);var b=a[1];this.parameters.push({inout:{"in":c.IN,out:c.OUT,inout:c.INOUT}[a[2]||"in"],name:a[4],type:this.type(a[3],a[5]),signature:b})}.bind(this)))},parseCode:function(a){function b(a,
b){if(!a.global)throw"Can't findAll non-global regexp";for(var c,e=[];c=a.exec(b);)e.push(c);return e}a=a.replace(/\r\n?/g,"\n").replace(/\/\/[^\n]*\n/g," ").replace(/\/\*(.|\n)*?\*\//g," ");var c=b(/(?:^|;)\s*attribute\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),d=b(/(?:^|;)\s*uniform\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),g=b(/(?:^|;)\s*varying\s+(([A-Za-z0-9]+)\s+([[A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),f=b(/(?:^|;)\s*void\s+([A-Za-z0-9]+)\s*\(([^\)]*)\)\s*{/g,
a);if(!f[0])throw"Could not parse shader snippet. Must contain a void-returning function with in/outs: "+a;var h=a;_.each({parseAttribute:c,parseUniform:d,parseVarying:g},function(a,b){_.each(a,function(a){this[b](a);h=h.replace(a[0],"")}.bind(this))}.bind(this));h=h.replace(/^\s*;/,"");this.parseSignature(f[0]);this.body=h}}})(ShaderGraph);
(function(c){c.Graph=function(a,b){this.parent=b||null;this.nodes=[];a&&this.add(a)};c.Graph.prototype={iterate:function(a){_.each(this.nodes,function(b){a(b,b._owner)})},exposed:function(){var a=[];this.iterate(function(b){_.each(b.outlets(),function(b){b.exposed&&a.push(b)})});return a},inputs:function(){var a=[];this.iterate(function(b){_.each(b.inputs,function(b){null==b.input&&a.push(b)})});return a},outputs:function(){var a=[];this.iterate(function(b){_.each(b.outputs,function(b){0==b.output.length&&
a.push(b)})});return a},tail:function(){return this.nodes[this.nodes.length-1]},add:function(a){if(a.constructor==Array)return _.each(a,function(a){this.add(a)}.bind(this));if(a.graph)throw"Adding node to two graphs at once";a.link(this);this.nodes.push(a)},remove:function(a,b){var c=this;if(a.constructor==Array)return _.each(a,function(a){c.remove(a)});if(a.graph!=this)throw"Removing node from wrong graph.";b||a.disconnect();this.nodes.splice(this.nodes.indexOf(a),1)}};c.IN=0;c.OUT=1;c.INOUT=2})(ShaderGraph);
(function(c){c.Node=function(a,b){this.graph=null;this.inputs=[];this.outputs=[];this._outlets={};this.owner(a);this.outlets(b)};c.Node.prototype={owner:function(a){return void 0!==a?(this._owner=a,this):this._owner},link:function(a){this.graph=a},getIn:function(a){return this.get(a,c.IN)},getOut:function(a){return this.get(a,c.OUT)},get:function(a,b){return void 0===b?this.get(a,c.IN)||this.get(a,c.OUT):this._outlets[[a,b].join("-")]},key:function(a){return[a.name,a.inout].join("-")},outlets:function(a){if(void 0!==
a){var b={};_.each(a,function(a){b[[a.name,a.inout,a.type].join("-")]=!0}.bind(this));_.each(this._outlets,function(a){b[[a.name,a.inout,a.type].join("-")]||this.remove(a)}.bind(this));_.each(a,function(a){var b=this.get(a.name,a.inout);b?b.morph(a):(a=new c.Outlet(a),this.add(a))}.bind(this));return this}return this._outlets},add:function(a){var b=this.key(a);outlets=this._outlets;_in=this.inputs;_out=this.outputs;if(a.node)throw"Adding outlet to two nodes at once.";if(outlets[b])throw"Adding two identical outlets to same node.";
a.link(this);outlets[b]=a;(a.inout==c.IN?_in:_out).push(a);return this},remove:function(a){var b=this._outlets,e=this.key(a),d=a.inout==c.IN?this.inputs:this.outputs;if(a.node!=this)throw"Removing outlet from wrong node.";a.disconnect();a.link(null);delete b[e];d.splice(d.indexOf(a),1);return this},connect:function(a,b,c){var d={},g={};_.each(a.inputs,function(a){if(c||!a.input){var b=a.type,k=[b,a.hint].join("-");g[k]||(g[k]=a);d[b]=d[b]||[];d[b].push(a)}});_.each(this.outputs,function(a){if(!b||
!a.output.length){var c=a.type,e=[c,a.hint].join("-");g[e]?(g[e].connect(a),delete g[e],d[c].splice(d[c].indexOf(a),1)):d[c]&&d[c].length&&d[c].shift().connect(a)}});return this},disconnect:function(a){_.each(this.inputs,function(a){a.disconnect()});_.each(this.outputs,function(a){a.disconnect()});return this}}})(ShaderGraph);
(function(c){c.Outlets=0;c.Outlet=function(a,b,e,d,g,f,h){if("object"==typeof a)return new c.Outlet(a.inout,a.name,a.hint,a.type,a.category,a.exposed,a.meta);this.node=null;this.inout=a;this.name=b;this.hint=e||b;this.type=d;this.category=g;this.exposed=!!f;this.meta=h||{};this.index=++c.Outlets;this.input=this.key=null;this.output=[]};c.Outlet.prototype={id:function(){return["_sg",this.name,this.index].join("_")},expose:function(a){this.exposed=a},morph:function(a){this.inout=a.inout;this.name=a.name;
this.type=a.type;this.category=a.category;this.exposed=a.exposed;this.meta=a.meta||{}},connect:function(a){if(this.inout==c.IN&&a.inout==c.OUT)return a.connect(this);if(this.inout!=c.OUT||a.inout!=c.IN)throw console.log(this,a),"Can't connect out/out or in/in outlets.";a.input!=this&&(a.disconnect(),a.input=this,this.output.push(a))},disconnect:function(a){if(this.inout==c.IN)this.input&&this.input.disconnect(this);else if(a){var b=this.output.indexOf(a);0<=b&&(this.output.splice(b,1),a.input=null)}else _.each(this.output,
function(a){a.input=null}),this.output=[]},link:function(a){this.node=a}}})(ShaderGraph);
