(function(){function f(d,a,l){if(d===a)return 0!==d||1/d==1/a;if(null==d||null==a)return d===a;d._chain&&(d=d._wrapped);a._chain&&(a=a._wrapped);if(d.isEqual&&c.isFunction(d.isEqual))return d.isEqual(a);if(a.isEqual&&c.isFunction(a.isEqual))return a.isEqual(d);var b=m.call(d);if(b!=m.call(a))return!1;switch(b){case "[object String]":return d==""+a;case "[object Number]":return d!=+d?a!=+a:0==d?1/d==1/a:d==+a;case "[object Date]":case "[object Boolean]":return+d==+a;case "[object RegExp]":return d.source==
a.source&&d.global==a.global&&d.multiline==a.multiline&&d.ignoreCase==a.ignoreCase}if("object"!=typeof d||"object"!=typeof a)return!1;for(var e=l.length;e--;)if(l[e]==d)return!0;l.push(d);var e=0,h=!0;if("[object Array]"==b){if(e=d.length,h=e==a.length)for(;e--&&(h=e in d==e in a&&f(d[e],a[e],l)););}else{if("constructor"in d!="constructor"in a||d.constructor!=a.constructor)return!1;for(var g in d)if(c.has(d,g)&&(e++,!(h=c.has(a,g)&&f(d[g],a[g],l))))break;if(h){for(g in a)if(c.has(a,g)&&!e--)break;
h=!e}}l.pop();return h}var a=this,b=a._,e={},h=Array.prototype,k=Object.prototype,g=h.slice,n=h.unshift,m=k.toString,I=k.hasOwnProperty,r=h.forEach,z=h.map,A=h.reduce,B=h.reduceRight,C=h.filter,D=h.every,E=h.some,t=h.indexOf,F=h.lastIndexOf,k=Array.isArray,J=Object.keys,u=Function.prototype.bind,c=function(d){return new q(d)};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=c),exports._=c):a._=c;c.VERSION="1.3.3";var p=c.each=c.forEach=function(d,
a,l){if(null!=d)if(r&&d.forEach===r)d.forEach(a,l);else if(d.length===+d.length)for(var b=0,f=d.length;b<f&&!(b in d&&a.call(l,d[b],b,d)===e);b++);else for(b in d)if(c.has(d,b)&&a.call(l,d[b],b,d)===e)break};c.map=c.collect=function(d,a,c){var b=[];if(null==d)return b;if(z&&d.map===z)return d.map(a,c);p(d,function(d,e,f){b[b.length]=a.call(c,d,e,f)});d.length===+d.length&&(b.length=d.length);return b};c.reduce=c.foldl=c.inject=function(d,a,l,b){var e=2<arguments.length;null==d&&(d=[]);if(A&&d.reduce===
A)return b&&(a=c.bind(a,b)),e?d.reduce(a,l):d.reduce(a);p(d,function(d,c,f){e?l=a.call(b,l,d,c,f):(l=d,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return l};c.reduceRight=c.foldr=function(d,a,l,b){var e=2<arguments.length;null==d&&(d=[]);if(B&&d.reduceRight===B)return b&&(a=c.bind(a,b)),e?d.reduceRight(a,l):d.reduceRight(a);var f=c.toArray(d).reverse();b&&!e&&(a=c.bind(a,b));return e?c.reduce(f,a,l,b):c.reduce(f,a)};c.find=c.detect=function(d,a,c){var b;G(d,function(d,
e,f){if(a.call(c,d,e,f))return b=d,!0});return b};c.filter=c.select=function(d,a,c){var b=[];if(null==d)return b;if(C&&d.filter===C)return d.filter(a,c);p(d,function(d,e,f){a.call(c,d,e,f)&&(b[b.length]=d)});return b};c.reject=function(d,a,c){var b=[];if(null==d)return b;p(d,function(d,e,f){a.call(c,d,e,f)||(b[b.length]=d)});return b};c.every=c.all=function(d,a,c){var b=!0;if(null==d)return b;if(D&&d.every===D)return d.every(a,c);p(d,function(d,f,h){if(!(b=b&&a.call(c,d,f,h)))return e});return!!b};
var G=c.some=c.any=function(d,a,b){a||(a=c.identity);var f=!1;if(null==d)return f;if(E&&d.some===E)return d.some(a,b);p(d,function(d,c,h){if(f||(f=a.call(b,d,c,h)))return e});return!!f};c.include=c.contains=function(d,a){var c=!1;return null==d?c:t&&d.indexOf===t?-1!=d.indexOf(a):c=G(d,function(d){return d===a})};c.invoke=function(d,a){var b=g.call(arguments,2);return c.map(d,function(d){return(c.isFunction(a)?a||d:d[a]).apply(d,b)})};c.pluck=function(d,a){return c.map(d,function(d){return d[a]})};
c.max=function(d,a,b){if(!a&&c.isArray(d)&&d[0]===+d[0])return Math.max.apply(Math,d);if(!a&&c.isEmpty(d))return-Infinity;var e={computed:-Infinity};p(d,function(d,c,f){c=a?a.call(b,d,c,f):d;c>=e.computed&&(e={value:d,computed:c})});return e.value};c.min=function(d,a,b){if(!a&&c.isArray(d)&&d[0]===+d[0])return Math.min.apply(Math,d);if(!a&&c.isEmpty(d))return Infinity;var e={computed:Infinity};p(d,function(d,c,f){c=a?a.call(b,d,c,f):d;c<e.computed&&(e={value:d,computed:c})});return e.value};c.shuffle=
function(d){var a=[],c;p(d,function(d,b){c=Math.floor(Math.random()*(b+1));a[b]=a[c];a[c]=d});return a};c.sortBy=function(d,a,b){var e=c.isFunction(a)?a:function(d){return d[a]};return c.pluck(c.map(d,function(d,a,c){return{value:d,criteria:e.call(b,d,a,c)}}).sort(function(d,a){var c=d.criteria,b=a.criteria;return void 0===c?1:void 0===b?-1:c<b?-1:c>b?1:0}),"value")};c.groupBy=function(d,a){var b={},e=c.isFunction(a)?a:function(d){return d[a]};p(d,function(d,a){var c=e(d,a);(b[c]||(b[c]=[])).push(d)});
return b};c.sortedIndex=function(d,a,b){b||(b=c.identity);for(var e=0,f=d.length;e<f;){var h=e+f>>1;b(d[h])<b(a)?e=h+1:f=h}return e};c.toArray=function(d){return d?c.isArray(d)||c.isArguments(d)?g.call(d):d.toArray&&c.isFunction(d.toArray)?d.toArray():c.values(d):[]};c.size=function(d){return c.isArray(d)?d.length:c.keys(d).length};c.first=c.head=c.take=function(d,a,c){return null==a||c?d[0]:g.call(d,0,a)};c.initial=function(d,a,c){return g.call(d,0,d.length-(null==a||c?1:a))};c.last=function(d,a,
c){return null==a||c?d[d.length-1]:g.call(d,Math.max(d.length-a,0))};c.rest=c.tail=function(d,a,c){return g.call(d,null==a||c?1:a)};c.compact=function(d){return c.filter(d,function(d){return!!d})};c.flatten=function(d,a){return c.reduce(d,function(d,b){if(c.isArray(b))return d.concat(a?b:c.flatten(b));d[d.length]=b;return d},[])};c.without=function(d){return c.difference(d,g.call(arguments,1))};c.uniq=c.unique=function(d,a,b){b=b?c.map(d,b):d;var e=[];3>d.length&&(a=!0);c.reduce(b,function(b,f,l){(a?
c.last(b)===f&&b.length:c.include(b,f))||(b.push(f),e.push(d[l]));return b},[]);return e};c.union=function(){return c.uniq(c.flatten(arguments,!0))};c.intersection=c.intersect=function(d){var a=g.call(arguments,1);return c.filter(c.uniq(d),function(d){return c.every(a,function(a){return 0<=c.indexOf(a,d)})})};c.difference=function(d){var a=c.flatten(g.call(arguments,1),!0);return c.filter(d,function(d){return!c.include(a,d)})};c.zip=function(){for(var d=g.call(arguments),a=c.max(c.pluck(d,"length")),
b=Array(a),e=0;e<a;e++)b[e]=c.pluck(d,""+e);return b};c.indexOf=function(d,a,b){if(null==d)return-1;var e;if(b)return b=c.sortedIndex(d,a),d[b]===a?b:-1;if(t&&d.indexOf===t)return d.indexOf(a);b=0;for(e=d.length;b<e;b++)if(b in d&&d[b]===a)return b;return-1};c.lastIndexOf=function(d,a){if(null==d)return-1;if(F&&d.lastIndexOf===F)return d.lastIndexOf(a);for(var b=d.length;b--;)if(b in d&&d[b]===a)return b;return-1};c.range=function(d,a,b){1>=arguments.length&&(a=d||0,d=0);b=arguments[2]||1;for(var c=
Math.max(Math.ceil((a-d)/b),0),e=0,f=Array(c);e<c;)f[e++]=d,d+=b;return f};var H=function(){};c.bind=function(d,a){var b,e;if(d.bind===u&&u)return u.apply(d,g.call(arguments,1));if(!c.isFunction(d))throw new TypeError;e=g.call(arguments,2);return b=function(){if(!(this instanceof b))return d.apply(a,e.concat(g.call(arguments)));H.prototype=d.prototype;var c=new H,f=d.apply(c,e.concat(g.call(arguments)));return Object(f)===f?f:c}};c.bindAll=function(a){var b=g.call(arguments,1);0==b.length&&(b=c.functions(a));
p(b,function(b){a[b]=c.bind(a[b],a)});return a};c.memoize=function(a,b){var e={};b||(b=c.identity);return function(){var f=b.apply(this,arguments);return c.has(e,f)?e[f]:e[f]=a.apply(this,arguments)}};c.delay=function(a,b){var c=g.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)};c.defer=function(a){return c.delay.apply(c,[a,1].concat(g.call(arguments,1)))};c.throttle=function(a,b){var e,f,h,g,k,n,r=c.debounce(function(){k=g=!1},b);return function(){e=this;f=arguments;h||
(h=setTimeout(function(){h=null;k&&a.apply(e,f);r()},b));g?k=!0:n=a.apply(e,f);r();g=!0;return n}};c.debounce=function(a,b,c){var e;return function(){var f=this,h=arguments;c&&!e&&a.apply(f,h);clearTimeout(e);e=setTimeout(function(){e=null;c||a.apply(f,h)},b)}};c.once=function(a){var b=!1,c;return function(){if(b)return c;b=!0;return c=a.apply(this,arguments)}};c.wrap=function(a,b){return function(){var c=[a].concat(g.call(arguments,0));return b.apply(this,c)}};c.compose=function(){var a=arguments;
return function(){for(var b=arguments,c=a.length-1;0<=c;c--)b=[a[c].apply(this,b)];return b[0]}};c.after=function(a,b){return 0>=a?b():function(){if(1>--a)return b.apply(this,arguments)}};c.keys=J||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[],e;for(e in a)c.has(a,e)&&(b[b.length]=e);return b};c.values=function(a){return c.map(a,c.identity)};c.functions=c.methods=function(a){var b=[],e;for(e in a)c.isFunction(a[e])&&b.push(e);return b.sort()};c.extend=function(a){p(g.call(arguments,
1),function(b){for(var c in b)a[c]=b[c]});return a};c.pick=function(a){var b={};p(c.flatten(g.call(arguments,1)),function(c){c in a&&(b[c]=a[c])});return b};c.defaults=function(a){p(g.call(arguments,1),function(b){for(var c in b)null==a[c]&&(a[c]=b[c])});return a};c.clone=function(a){return c.isObject(a)?c.isArray(a)?a.slice():c.extend({},a):a};c.tap=function(a,b){b(a);return a};c.isEqual=function(a,b){return f(a,b,[])};c.isEmpty=function(a){if(null==a)return!0;if(c.isArray(a)||c.isString(a))return 0===
a.length;for(var b in a)if(c.has(a,b))return!1;return!0};c.isElement=function(a){return!(!a||1!=a.nodeType)};c.isArray=k||function(a){return"[object Array]"==m.call(a)};c.isObject=function(a){return a===Object(a)};c.isArguments=function(a){return"[object Arguments]"==m.call(a)};c.isArguments(arguments)||(c.isArguments=function(a){return!(!a||!c.has(a,"callee"))});c.isFunction=function(a){return"[object Function]"==m.call(a)};c.isString=function(a){return"[object String]"==m.call(a)};c.isNumber=function(a){return"[object Number]"==
m.call(a)};c.isFinite=function(a){return c.isNumber(a)&&isFinite(a)};c.isNaN=function(a){return a!==a};c.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"==m.call(a)};c.isDate=function(a){return"[object Date]"==m.call(a)};c.isRegExp=function(a){return"[object RegExp]"==m.call(a)};c.isNull=function(a){return null===a};c.isUndefined=function(a){return void 0===a};c.has=function(a,b){return I.call(a,b)};c.noConflict=function(){a._=b;return this};c.identity=function(a){return a};c.times=
function(a,b,c){for(var e=0;e<a;e++)b.call(c,e)};c.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};c.result=function(a,b){if(null==a)return null;var e=a[b];return c.isFunction(e)?e.call(a):e};c.mixin=function(a){p(c.functions(a),function(b){K(b,c[b]=a[b])})};var L=0;c.uniqueId=function(a){var b=L++;return a?a+b:b};c.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,
escape:/<%-([\s\S]+?)%>/g};var v=/.^/,s={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"},w;for(w in s)s[s[w]]=w;var M=/\\|'|\r|\n|\t|\u2028|\u2029/g,N=/\\(\\|'|r|n|t|u2028|u2029)/g,x=function(a){return a.replace(N,function(a,b){return s[b]})};c.template=function(a,b,e){e=c.defaults(e||{},c.templateSettings);a="__p+='"+a.replace(M,function(a){return"\\"+s[a]}).replace(e.escape||v,function(a,b){return"'+\n_.escape("+x(b)+")+\n'"}).replace(e.interpolate||v,function(a,b){return"'+\n("+
x(b)+")+\n'"}).replace(e.evaluate||v,function(a,b){return"';\n"+x(b)+"\n;__p+='"})+"';\n";e.variable||(a="with(obj||{}){\n"+a+"}\n");a="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+a+"return __p;\n";var f=new Function(e.variable||"obj","_",a);if(b)return f(b,c);b=function(a){return f.call(this,a,c)};b.source="function("+(e.variable||"obj")+"){\n"+a+"}";return b};c.chain=function(a){return c(a).chain()};var q=function(a){this._wrapped=a};c.prototype=q.prototype;
var y=function(a,b){return b?c(a).chain():a},K=function(a,b){q.prototype[a]=function(){var a=g.call(arguments);n.call(a,this._wrapped);return y(b.apply(c,a),this._chain)}};c.mixin(c);p("pop push reverse shift sort splice unshift".split(" "),function(a){var b=h[a];q.prototype[a]=function(){var c=this._wrapped;b.apply(c,arguments);var e=c.length;"shift"!=a&&"splice"!=a||0!==e||delete c[0];return y(c,this._chain)}});p(["concat","join","slice"],function(a){var b=h[a];q.prototype[a]=function(){return y(b.apply(this._wrapped,
arguments),this._chain)}});q.prototype.chain=function(){this._chain=!0;return this};q.prototype.value=function(){return this._wrapped}}).call(this);(function(f){for(var a in f)if(!window[a])throw"Error: ShaderGraph requires "+f[a];})({THREE:"Three.js"});window.ShaderGraph={};ShaderGraph.getShader=function(f){var a=document.getElementById(f);return a&&(a.innerText||a.textContent)||f};
(function(f){f.Block=function(a){a=a||new f.Node;this.node(a);this.children=[];this.parent=null;this.properties={};this.index=++f.Block.index;this.refresh()};f.Block.index=0;f.Block.prototype={node:function(a){return void 0!==a?(this._node=a,this):this._node},refresh:function(){this._node.owner(this);this._node.outlets(this.outlets())},fetch:function(a,b,e,f){},id:function(a,b,e,h){if(e.meta.inout){var k=e.node.get(e.name,f.IN).input;if(k)return k.node.owner().fetch(a,b,k,h+1)}return e.id()}};f.Block.Snippet=
function(a){this.snippet=new f.Snippet(a);f.Block.call(this)};f.Block.Snippet.prototype=_.extend({},f.Block.prototype,{insert:function(a,b,e){f.Block.Snippet.compileCall(a,b,this.node(),this.snippet,e)},fetch:function(a,b,e,f){a.include(this,b)||this.insert(a,b,f);return this.id(a,b,e,f)},outlets:function(){return f.Block.Snippet.makeOutlets(this.snippet)}});f.Block.Material=function(a,b){this.vertex=new f.Snippet(a);this.fragment=new f.Snippet(b);f.Block.call(this)};f.Block.Material.prototype=_.extend({},
f.Block.prototype,{compile:function(){if(0<this.node().outputs.length)throw"Can't compile material with outputs";this.node();var a=new f.Program;this.insert(a,"vertex",0);this.insert(a,"fragment",0);a.compile();return a},insert:function(a,b,e){f.Block.Snippet.compileCall(a,b,this.node(),this[b],e)},fetch:function(a,b,e,f){a.include(this,b)||this.insert(a,b,f);"fragment"==b&&(a.include(this,"vertex")||this.insert(a,"vertex",0));return this.id(a,b,e,f)},outlets:function(){var a=f.Block.Snippet.makeOutlets(this.vertex),
b=f.Block.Snippet.makeOutlets(this.fragment);return _.union(a,b)}});f.Block.Snippet.makeOutlets=function(a){var b=[];if(a.outlets)return a.outlets;var e=a.arguments();_.each(e.parameters,function(a){a=_.extend({},a);a.meta={required:!0};a.hint=a.name.replace(/(In|Out)$/,"");a.category="parameter";if(a.inout==f.INOUT){a.meta.inout=!0;var e=_.extend({},a);e.inout=f.IN;b.push(e);a.inout=f.OUT}b.push(a)});_.each(e.uniforms,function(a){a.meta={};a.hint=a.name.replace(/(In|Out)$/,"");a.category="uniform";
a.inout=f.IN;b.push(a)});return a.outlets=b};f.Block.Snippet.compileCall=function(a,b,e,h,k){var g=h.arguments(),n=[];_.each(g.parameters,function(g){var h=e.get(g.name,g.inout==f.INOUT?f.IN:g.inout);if(g.inout==f.IN||g.inout==f.INOUT)if(h.input)h=h.input.node.owner().fetch(a,b,h.input,k+1),a.variable(b,h,g),n.push(h);else throw console.log("Outlet",g,input),["Missing connection on outlet for "+g.name];else g.inout==f.OUT&&(h=h.id(),a.variable(b,h,g),n.push(h))});var m=[];_.each(g.uniforms,function(f){var g=
e.get(f.name);g.input?(g=g.input.node.owner().fetch(a,b,g.input,k+1),a.variable(b,g,f),n.push(g),m.push(f.name)):a.external("uniform",f)});_.each(g.attributes,function(b){a.external("attribute",b)});_.each(g.varyings,function(b){a.external("varying",b)});g=["_sg",b,h.name,e.owner().index].join("_");h=h.compile(g,m,!0);a.add(b,g,n,h,k)}})(ShaderGraph);
(function(f){f.Factory=function(){this.end()};f.Factory.prototype={snippet:function(a,b){b=b||"append";var e=new f.Block.Snippet(ShaderGraph.getShader(a));this[b](e.node());return this},material:function(a,b,e){e=e||"append";a=new f.Block.Material(ShaderGraph.getShader(a),ShaderGraph.getShader(b));this[e](a.node());return this},snippetBefore:function(a){this.snippet(a,"prepend");return this},materialBefore:function(a,b){this.material(code,"prepend");return this},append:function(a){a.graph||this.graph.add(a);
var b=this.stack[0];_.each(b.end,function(b){b.connect(a)});b.start.length||(b.start=[a]);b.end=[a];return this},prepend:function(a){a.graph||this.graph.add(a);var b=this.stack[0];_.each(b.start,function(b){a.connect(b)});b.end.length||(b.end=[a]);b.start=[a];return this},group:function(){this.stack.unshift({start:[],end:[]});this.stack.unshift({start:[],end:[]});return this},pass:function(){this.next();this.stack[0].start.push(null);return this.combine()},next:function(){var a=this.stack.shift(),
b=this.stack[0];b.start=b.start.concat(a.start);b.end=b.end.concat(a.end);this.stack.unshift({start:[],end:[]});return this},combine:function(){if(2>=this.stack.length)throw"Popping factory stack too far.";this.next();this.stack.shift();var a=this.stack.shift(),b=this.stack[0];a.start.length&&(_.each(a.start,function(e){e?_.each(b.end,function(a){a.connect(e,!0)}):a.end=a.end.concat(b.end)}),b.end=a.end);return this},end:function(){var a=this.graph;this.graph=new f.Graph;this.stack=[];this.group();
a&&(a.compile=function(){return a.tail().owner().compile()});return a}}})(ShaderGraph);
(function(f){f.Program=function(){this.calls={vertex:{},fragment:{}};this.variables={vertex:{},fragment:{}};this.externals={};this.compiled=!1;this.attributes={};this.uniforms={};this.fragmentShader=this.vertexShader="";this.includes={vertex:[],fragment:[]}};f.Program.types={f:"float",v2:"vec2",v3:"vec3",v4:"vec4",m3:"mat3",m4:"mat4",t:"sampler2D"};f.Program.prototype={include:function(a,b){if(0<=this.includes[b].indexOf(a))return!0;this.includes[b].push(a);return!1},external:function(a,b){b=_.extend({category:a},
b);this.externals[b.name]=b},variable:function(a,b,e){e=_.extend({},e,{name:b});this.variables[a][b]=e},add:function(a,b,e,f,k){var g=this.calls[a][b];g?g.priority=Math.min(g.priority,k):this.calls[a][b]={name:b,args:e,code:f,priority:k}},compile:function(){_.each(this.externals,function(a){"uniform"==a.category&&(this.uniforms[a.name]={type:a.type,value:a.value});"attribute"==a.category&&(this.attributes[a.name]={type:a.type,value:[]})}.bind(this));_.each(["vertex","fragment"],function(a){var b=
[];_.each(this.externals,function(e){"attribute"==e.category&&"fragment"==a||b.push([e.category,e.signature,";"].join(" "))}.bind(this));var b=b.join("\n"),e=_.toArray(this.calls[a]),h=[b],k=["void main() {"];_.each(this.variables[a],function(a){k.push([f.Program.types[a.type],a.name,";"].join(" "))});e.sort(function(a,b){return b.priority-a.priority});_.each(e,function(a){h.push(a.code);k.push([a.name,"(",a.args.join(","),");"].join(""))});k.push("}");this[a+"Shader"]=[h.join("\n"),k.join("\n")].join("\n")}.bind(this));
this.compiled=!0},material:function(){if(!this.compiled)throw"Fetching material from uncompiled program.";return new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:this.vertex,fragmentShader:this.fragment})}}})(ShaderGraph);
(function(f){f.Snippet=function(a){if(f.Snippet.cache[a])return f.Snippet.cache[a];f.Snippet.cache[a]=this;this.code=a;this.attributes=[];this.uniforms=[];this.varyings=[];this.parameters=[];this.body=this.signature="";this.parseCode(a)};f.Snippet.cache={};f.Snippet.types={"float":"f",vec2:"v2",vec3:"v3",vec4:"v4",mat3:"m3",mat4:"m4",sampler2D:"t",samplerCube:"t"};f.Snippet.defaults={"float":0,vec2:new THREE.Vector3,vec3:new THREE.Vector3,vec4:new THREE.Vector4,mat4:new THREE.Matrix4,sampler2D:0,
samplerCube:0};f.Snippet.prototype={compile:function(a,b,e){var f=this.signature.slice(),k=[];b=b||[];_.each(this.uniforms,function(a){0<=b.indexOf(a.name)?f.push(a.signature):e||k.push(["uniform",a.signature].join(" "))});!e&&_.each(this.attributes,function(a){k.push(["attribute",a.signature].join(" "))});!e&&_.each(this.varyings,function(a){k.push(["varying",a.signature].join(" "))});a=this.body.replace(/\s*void\s+([A-Za-z0-9]+)\s*\([^\)]*\)/g,["void",a+"(",f.join(", "),")"].join(" "));k.push(a);
return k.join(";\n")},arguments:function(){return{uniforms:this.uniforms,varyings:this.varyings,attributes:this.attributes,parameters:this.parameters}},type:function(a,b){a=(f.Snippet.types[a]||"f")+(b?"v":"");return"fv"==a?"fv1":a},parseAttribute:function(a){var b=a[1];this.attributes.push({name:a[3],type:this.type(a[2],a[4]),signature:b})},parseUniform:function(a){var b=a[1],e=a[2];this.uniforms.push({name:a[3],type:this.type(e,a[4]),value:f.Snippet.defaults[e]||0,signature:b})},parseVarying:function(a){var b=
a[1];this.varyings.push({name:a[3],type:this.type(a[2],a[4]),signature:b})},parseSignature:function(a){this.name=a[1];var b=a[2].replace(/^\s*$/g,"");0==b.length?this.signature=[]:(arguments=this.signature=b.split(","),_.each(arguments,function(a){a=/((?:(in|out|inout)\s+)?([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/.exec(a);var b=a[1];this.parameters.push({inout:{"in":f.IN,out:f.OUT,inout:f.INOUT}[a[2]||"in"],name:a[4],type:this.type(a[3],a[5]),signature:b})}.bind(this)))},parseCode:function(a){function b(a,
b){if(!a.global)throw"Can't findAll non-global regexp";for(var e,f=[];e=a.exec(b);)f.push(e);return f}a=a.replace(/\r\n?/g,"\n").replace(/\/\/[^\n]*\n/g," ").replace(/\/\*(.|\n)*?\*\//g," ");var e=b(/(?:^|;)\s*attribute\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),f=b(/(?:^|;)\s*uniform\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),k=b(/(?:^|;)\s*varying\s+(([A-Za-z0-9]+)\s+([[A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),g=b(/(?:^|;)\s*void\s+([A-Za-z0-9]+)\s*\(([^\)]*)\)\s*{/g,
a);if(!g[0])throw"Could not parse shader snippet. Must contain a void-returning function with in/outs: "+a;var n=a;_.each({parseAttribute:e,parseUniform:f,parseVarying:k},function(a,b){_.each(a,function(a){this[b](a);n=n.replace(a[0],"")}.bind(this))}.bind(this));n=n.replace(/^\s*;/,"");this.parseSignature(g[0]);this.body=n}}})(ShaderGraph);
(function(f){f.Graph=function(a,b){this.parent=b||null;this.nodes=[];a&&this.add(a)};f.Graph.prototype={iterate:function(a){_.each(this.nodes,function(b){a(b,b._owner)})},exposed:function(){var a=[];this.iterate(function(b){_.each(b.outlets(),function(b){b.exposed&&a.push(b)})});return a},inputs:function(){var a=[];this.iterate(function(b){_.each(b.inputs,function(b){null==b.input&&a.push(b)})});return a},outputs:function(){var a=[];this.iterate(function(b){_.each(b.outputs,function(b){0==b.output.length&&
a.push(b)})});return a},tail:function(){return this.nodes[this.nodes.length-1]},add:function(a){if(a.constructor==Array)return _.each(a,function(a){this.add(a)}.bind(this));if(a.graph)throw"Adding node to two graphs at once";a.link(this);this.nodes.push(a)},remove:function(a,b){var e=this;if(a.constructor==Array)return _.each(a,function(a){e.remove(a)});if(a.graph!=this)throw"Removing node from wrong graph.";b||a.disconnect();this.nodes.splice(this.nodes.indexOf(a),1)}};f.IN=0;f.OUT=1;f.INOUT=2})(ShaderGraph);
(function(f){f.Node=function(a,b){this.graph=null;this.inputs=[];this.outputs=[];this._outlets={};this.owner(a);this.outlets(b)};f.Node.prototype={owner:function(a){return void 0!==a?(this._owner=a,this):this._owner},link:function(a){this.graph=a},getIn:function(a){return this.get(a,f.IN)},getOut:function(a){return this.get(a,f.OUT)},get:function(a,b){return void 0===b?this.get(a,f.IN)||this.get(a,f.OUT):this._outlets[[a,b].join("-")]},key:function(a){return[a.name,a.inout].join("-")},outlets:function(a){if(void 0!==
a){var b={};_.each(a,function(a){b[[a.name,a.inout,a.type].join("-")]=!0}.bind(this));_.each(this._outlets,function(a){b[[a.name,a.inout,a.type].join("-")]||this.remove(a)}.bind(this));_.each(a,function(a){var b=this.get(a.name,a.inout);b?b.morph(a):(a=new f.Outlet(a),this.add(a))}.bind(this));return this}return this._outlets},add:function(a){var b=this.key(a);outlets=this._outlets;_in=this.inputs;_out=this.outputs;if(a.node)throw"Adding outlet to two nodes at once.";if(outlets[b])throw"Adding two identical outlets to same node.";
a.link(this);outlets[b]=a;(a.inout==f.IN?_in:_out).push(a);return this},remove:function(a){var b=this._outlets,e=this.key(a),h=a.inout==f.IN?this.inputs:this.outputs;if(a.node!=this)throw"Removing outlet from wrong node.";a.disconnect();a.link(null);delete b[e];h.splice(h.indexOf(a),1);return this},connect:function(a,b,e){var f={},k={};_.each(a.inputs,function(a){if(e||!a.input){var b=a.type,m=[b,a.hint].join("-");k[m]||(k[m]=a);f[b]=f[b]||[];f[b].push(a)}});_.each(this.outputs,function(a){if(!b||
!a.output.length){var e=a.type,m=[e,a.hint].join("-");k[m]?(k[m].connect(a),delete k[m],f[e].splice(f[e].indexOf(a),1)):f[e]&&f[e].length&&f[e].shift().connect(a)}});return this},disconnect:function(a){_.each(this.inputs,function(a){a.disconnect()});_.each(this.outputs,function(a){a.disconnect()});return this}}})(ShaderGraph);
(function(f){f.Outlets=0;f.Outlet=function(a,b,e,h,k,g,n){if("object"==typeof a)return new f.Outlet(a.inout,a.name,a.hint,a.type,a.category,a.exposed,a.meta);this.node=null;this.inout=a;this.name=b;this.hint=e||b;this.type=h;this.category=k;this.exposed=!!g;this.meta=n||{};this.index=++f.Outlets;this.input=this.key=null;this.output=[]};f.Outlet.prototype={id:function(){return["_sg",this.name,this.index].join("_")},expose:function(a){this.exposed=a},morph:function(a){this.inout=a.inout;this.name=a.name;
this.type=a.type;this.category=a.category;this.exposed=a.exposed;this.meta=a.meta||{}},connect:function(a){if(this.inout==f.IN&&a.inout==f.OUT)return a.connect(this);if(this.inout!=f.OUT||a.inout!=f.IN)throw console.log(this,a),"Can't connect out/out or in/in outlets.";a.input!=this&&(a.disconnect(),a.input=this,this.output.push(a))},disconnect:function(a){if(this.inout==f.IN)this.input&&this.input.disconnect(this);else if(a){var b=this.output.indexOf(a);0<=b&&(this.output.splice(b,1),a.input=null)}else _.each(this.output,
function(a){a.input=null}),this.output=[]},link:function(a){this.node=a}}})(ShaderGraph);
